# -*- coding: utf-8 -*-
# ---------------------------------------------------------------------------
# merge_layers.py
# Created on: 2014-05-21 09:48:06.00000
#   (generated by ArcGIS/ModelBuilder)
# Description: 
# ---------------------------------------------------------------------------


import os
import glob
import arcpy
import xml.etree.ElementTree as ET
import archiver
import settings
import metadata
import import_layers


def create_field_map(layer_name, input_field_name, output_field_name):
  
    fm = arcpy.FieldMap()
    fm.addInputField(layer_name, input_field_name)
    output_field = fm.outputField
    output_field.name = output_field_name
    fm.outputField = output_field

    return fm


def empty_strings2null(fclass):
    desc = arcpy.Describe(fclass)
    if desc.dataType == 'FeatureClass':
        string_fields = [f.name for f in arcpy.ListFields(fclass, None, 'String')]
        for string_field in string_fields:
            arcpy.MakeFeatureLayer_management(fclass, "update_layer", '"%s" = \'\'' % string_field, "", "")
            arcpy.CalculateField_management("update_layer", string_field, "None", "PYTHON", "")



def get_layer_def(layer_name, layer_defs):
    for layer in layer_defs:
        if layer.keys()[0] == layer_name:
            return layer[layer_name]
    return False


def remove_features(fc, countries):
    if not len(countries):
        # Deletes all features in target feature class
        arcpy.DeleteFeatures_management(fc)
    else:
        where_clause = ""
        for country in countries:
            if where_clause == "":
                where_clause = "country = '%s'" % country
            else:
                where_clause = "%s OR country = '%s'" % (where_clause, country)
            arcpy.MakeFeatureLayer_management(fc, "layer", where_clause)
            arcpy.DeleteFeatures_management("layer")

    # Compact target file-geodatabase to avoid running out of ObjectIDs
    arcpy.Compact_management(arcpy.env.workspace)


def get_all_description_elements(desc):
    elements = []
    root = ET.fromstring(desc)
    for parent in root.findall("DIV"):
        for element in parent.findall("DIV"):
            if "ID" in element.attrib:
                elements.append(element.attrib["ID"])
    return elements


def get_description_text(desc):
    root = ET.fromstring(desc)
    for element in root.iter("DIV"):
        if not element.find("P") is None:
            for att in element.attrib:
                element.attrib.pop(att)
            return ET.tostring(element)[5:-6] 


def remove_description_element(desc, desc_attrib):
    root = ET.fromstring(desc)
    for parent in root.findall("DIV"):
        for element in parent.findall("DIV"):
            if "ID" in element.attrib:
                if element.attrib["ID"] == desc_attrib:
                    #print ET.tostring(element)
                    parent.remove(element)
    desc = ET.tostring(root)
    return desc


def remove_countries_from_description(desc, countries, layer_def):
    if not len(countries):
        elements = get_all_description_elements(desc)
        for element in elements:
            if element != "global":
                desc = remove_description_element(desc, element)
    else:
        for layer in layer_def['layers']:
            if layer_def['layers'][layer]['country'] in countries:
                desc = remove_description_element(desc, layer)
    return desc


def append_description_element(desc, attrib, layer_name, text):
    root = ET.fromstring(desc)
    for element in root.findall("DIV"):
        if not len(element.attrib):
            desc_element = ET.fromstring("<DIV><H3>%s</H3>%s</DIV>" % (layer_name, text))
            desc_element.attrib['ID'] = attrib
            element.append(desc_element)
            break
    desc = ET.tostring(root)
    return desc


def remove_countries_from_place_keywords(keywords, countries):
    if not len(countries):
        return []
    else:
        return keywords


def add_country_to_place_keywords(keywords, country):
    iso3 = settings.get_country_iso3_list()
    if country.upper() in iso3:
        if not iso3[country].lower() in keywords:
            keywords.append(iso3[country].lower())
    return keywords


def update_tags(tags, countries):
    for country in countries:
        tags = tags + [country.lower()]
    return tags


def update_extent_desc(countries):
    extent_desc = "Currently available for "
    i = 0
    for country in countries:
        i += 1
        if i < len(countries):
            extent_desc = extent_desc + country + ", "
        else:
            extent_desc = extent_desc + "and " + country
    return extent_desc


def import_shapefile(shp, gdb, fc):
    arcpy.env.workspace = gdb
    if arcpy.Exists(fc):
        arcpy.Delete_management(fc)
    arcpy.FeatureClassToFeatureClass_conversion(shp, gdb, fc)


def clear_workspace(folder):
    files = glob.glob(os.path.join(folder, "*.*"))
    for f in files:
        try:
            os.remove(f)
        except:
            pass


def del_geoprocessing_history(meta):
    metadata_keys = settings.get_metadata_keys()
    metadata.remove_metadata_elements_by_etree(meta, metadata_keys["ARCGIS"]["geoprocessing_history"])
    return metadata


def merge(layers, countries):

    sets = settings.get_settings()
    layer_defs = settings.get_layers()

    workspace = sets['paths']['workspace']
    scratch_workspace = sets['paths']['scratch_workspace']
    export_folder = os.path.join(scratch_workspace, "export")
    if not os.path.exists(export_folder):
        os.mkdir(export_folder)

    default_srs = sets['spatial_references']['default_srs']
    gdb_srs = sets['spatial_references']['gdb_srs']

    arcpy.env.overwriteOutput = True
    clear_workspace(scratch_workspace)
    clear_workspace(export_folder)

    for layer_name in layers:

        layer_def = get_layer_def(layer_name, layer_defs)

        if not layer_def:
            print "Layer %s is not defined. Skip" % layer_name
            break

        print ""
        print "Merge %s" % layer_name
        print ""
        print "Define layer parameters"
        gdb = os.path.join(workspace, layer_def['gdb'])
        arcpy.env.workspace = gdb
        drive = sets['bucket_drives'][layer_def['bucket']]
        layer_folder = os.path.join(drive, layer_def['folder'])
        zip_folder = os.path.join(layer_folder, sets['folders']['zip_folder'])
        archive_folder = os.path.join(layer_folder, sets['folders']['archive_folder'])

        target_fc = os.path.join(gdb,layer_name)
        target_shp = os.path.join(layer_folder, layer_def['shapefile'])

        print "Get metadata"
        metadata_keys = settings.get_metadata_keys()
        meta = metadata.get_metadata_file(target_fc)

        meta_desc = metadata.get_metadata_element_by_etree(meta, metadata_keys["ARCGIS"]["description"])
        meta_extent_desc = metadata.get_metadata_element_by_etree(meta, metadata_keys["ARCGIS"]["extent_description"])
        meta_tags = layer_def["keywords"]
        meta_place_keywords = metadata.get_metadata_elements_by_etree(meta, metadata_keys["ARCGIS"]["place_keywords"])

        print "Remove country features"
        remove_features(target_fc, countries)

        print "Remove country metadata"
        meta_desc = remove_countries_from_description(meta_desc, countries, layer_def)
        meta_place_keywords = remove_countries_from_place_keywords(meta_place_keywords, countries)

        for l in layer_def['layers']:
            layer = layer_def['layers'][l]
            if layer['country'] in countries or not len(countries):

                print ""
                print "Add %s" % layer['alias']
                print ""

                print "Make local copy"

                input_shp = os.path.join(layer_folder, layer['shapefile'])
                local_shp = os.path.join(scratch_workspace, layer['shapefile'])
                arcpy.Copy_management(input_shp, local_shp)
                local_meta = metadata.get_metadata_file(local_shp)
                local_meta = del_geoprocessing_history(local_meta)

                import_layers.add_gfwid(local_shp)
                
                arcpy.env.outputCoordinateSystem = arcpy.SpatialReference(gdb_srs)

                if layer['transformation']:
                    arcpy.env.geographicTransformations = layer['transformation']

                
                input_layer = "input_layer"

                arcpy.MakeFeatureLayer_management(local_shp, input_layer, layer['where_clause'], "", "")

                fms = arcpy.FieldMappings()

                for field in layer['fields']:
                    if layer['fields'][field]:
                        if layer['fields'][field][0] == 'field':
                            fms.addFieldMap(create_field_map(input_layer, layer['fields'][field][1], field))

                #Make sure the gfwid is mapped as well
                fms.addFieldMap(create_field_map(input_layer, "gfwid", "gfwid"))

                # append layers to target feature class
                arcpy.Append_management(input_layer, target_fc, "NO_TEST", fms, "")

                print "Update fields"
                target_layer = "target_layer"
                arcpy.MakeFeatureLayer_management(target_fc, target_layer, "country IS NULL", "", "")

                for field in layer['fields']:
                    if layer['fields'][field]:

                        if layer['fields'][field][0].lower() == 'value':
                            arcpy.CalculateField_management(target_layer, field, "'%s'" % layer['fields'][field][1], "PYTHON", "")

                        elif layer['fields'][field][0].lower() == 'expression':
                            arcpy.CalculateField_management(target_layer, field, "%s" % layer['fields'][field][1], "PYTHON", "")

                arcpy.CalculateField_management(target_layer, "country", "'%s'" % layer['country'], "PYTHON", "")

                #convert empty strings ('') to NULL
                empty_strings2null(target_fc)

                print "Get country metadata"

                country_meta = metadata.get_metadata_file(local_shp)
                country_meta_desc = metadata.get_metadata_element_by_etree(country_meta, metadata_keys["ARCGIS"]["description"])
                country_meta_desc = get_description_text(country_meta_desc)
                meta_desc = append_description_element(meta_desc, l, layer['alias'], country_meta_desc)            
                meta_place_keywords = add_country_to_place_keywords(meta_place_keywords, layer['country'])
                
                print "Import country shapefile"
                import_shapefile(local_shp, gdb, l)

                print "Achive local country shapefile"
                archiver.archive_shapefile(local_shp, scratch_workspace, zip_folder, archive_folder, True)

                print "Transform country shapefile to WGS84 and archive"
                arcpy.env.outputCoordinateSystem = arcpy.SpatialReference(default_srs)
                arcpy.FeatureClassToShapefile_conversion([local_shp], export_folder)
                export_shp = os.path.join(export_folder, layer['shapefile'])
                archiver.archive_shapefile(export_shp, scratch_workspace, zip_folder, archive_folder, False)

                print "Copy local file to S3"
                arcpy.Copy_management(local_shp, input_shp)

        print ""
        print "Update layer metadata"
        meta_tags = update_tags(meta_tags, meta_place_keywords)
        meta_extent_desc = update_extent_desc(meta_place_keywords)

        meta = metadata.update_metadata_element(meta, metadata_keys["ARCGIS"]["description"], meta_desc)
        meta = metadata.update_metadata_element(meta, metadata_keys["ARCGIS"]["extent_description"], meta_extent_desc)

        meta = metadata.update_metadata_elements(meta, metadata_keys["ARCGIS"]["tags"], meta_tags)
        meta = metadata.update_metadata_elements(meta, metadata_keys["ARCGIS"]["place_keywords"], meta_place_keywords)

        metadata.import_metadata(target_fc, meta)

        arcpy.env.geographicTransformations = ""

        print "Archive layer"
        arcpy.env.outputCoordinateSystem = arcpy.SpatialReference(gdb_srs)
        arcpy.FeatureClassToShapefile_conversion([target_fc], scratch_workspace)
        export_shp = os.path.join(scratch_workspace, layer_def['shapefile'])
        export_meta = metadata.get_metadata_file(export_shp)
        export_meta = del_geoprocessing_history(export_meta)
        archiver.archive_shapefile(export_shp, scratch_workspace, zip_folder, archive_folder, True)

        print "Transform layer to WGS84 and archive"
        arcpy.env.outputCoordinateSystem = arcpy.SpatialReference(default_srs)
        arcpy.FeatureClassToShapefile_conversion([target_fc], export_folder)
        export_shp = os.path.join(export_folder, layer_def['shapefile'])
        export_meta = metadata.get_metadata_file(export_shp)
        export_meta = del_geoprocessing_history(export_meta)
        archiver.archive_shapefile(export_shp, scratch_workspace, zip_folder, archive_folder, False)

        print "Copy shapefile to S3"
        target_shp = os.path.join(layer_folder, layer_def['shapefile'])
        arcpy.Copy_management(export_shp, target_shp)

        #print "Remove temporay files"
        #clear_scratch_workspace()
